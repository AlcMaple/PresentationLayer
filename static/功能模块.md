# 桥梁评分系统功能模块开发文档

## 4.1. 通用CRUD功能模块

这里介绍通用CRUD（创建、读取、更新、删除）功能模块。

桥梁评分系统使用了统一的通用CRUD服务来处理基础数据表的操作，避免了大量重复代码的编写。基础模块路由中除了paths表外，所有的基础数据表（分类、桥梁类型、部位、结构类型、部件类型、构件形式、病害类型、标度、定性描述、定量描述等）都使用相同的CRUD接口模式。

### 核心实现

**主要实现文件:**
```
# 核心服务类
./services/base_crud.py - BaseCRUDService通用CRUD服务基类

# API路由实现
./api/categories.py - 分类管理API（代表性示例）
./api/bridge_types.py - 桥梁类型管理API  
./api/bridge_parts.py - 部位管理API
./api/bridge_structures.py - 结构类型管理API
# ... 其他基础数据表API

# 数据模型
./models/categories.py - 分类数据模型
./models/bridge_components.py - 桥梁组件数据模型
```

### 核心服务类 BaseCRUDService

BaseCRUDService是一个泛型基类，提供了标准化的CRUD操作:

```python
class BaseCRUDService(Generic[ModelType, CreateSchemaType, UpdateSchemaType], ABC):
```

### 主要功能方法

**数据查询:**
- `get_by_id(id, include_deleted)` - 根据ID查询单条记录
- `get_by_code(code, include_deleted)` - 根据编码查询单条记录  
- `get_list(page_params, filters, include_deleted)` - 分页查询列表

**数据操作:**
- `create(obj_in)` - 创建新记录，自动处理编码生成和重复检查
- `update(id, obj_in)` - 更新记录，支持部分字段更新
- `delete(id, cascade)` - 软删除记录，支持级联删除
- `delete_all(filters)` - 批量软删除

### 辅助功能

**代码生成器集成:**
- 自动生成唯一编码，如果用户未提供编码则系统自动分配
- 支持自定义编码验证和重复检查

**级联删除服务:**
- 当删除基础数据时，自动级联删除相关的路径数据
- 保证数据的完整性和一致性

**分页参数处理:**
- 统一的分页参数模型`PageParams`
- 自动计算偏移量，支持灵活的分页查询

**异常处理:**
- 标准化的异常处理，包括`NotFoundException`、`DuplicateException`等
- 统一的错误响应格式

### 业务逻辑场景

**创建数据流程:**
1. 接收前端提交的数据
2. 验证数据格式和必填字段
3. 检查名称重复性
4. 自动生成或验证编码
5. 创建数据库记录
6. 返回标准化响应

**查询数据流程:**
1. 接收查询参数（分页、过滤条件）
2. 构建查询条件（排除软删除记录）
3. 执行分页查询
4. 返回列表数据和总数

**更新数据流程:**
1. 验证记录存在性
2. 检查编码和名称冲突
3. 部分字段更新
4. 自动更新时间戳
5. 返回更新后的记录

---

## 4.2. 路径管理功能模块

这里介绍路径管理（Paths）功能模块。

路径管理是桥梁评分系统的核心元数据模块，用于存储和管理桥梁结构的层次化路径信息。它定义了从桥梁类别到定量描述的完整数据路径，为后续的用户路径创建和数据录入提供基础支撑。

### 核心实现

**主要实现文件:**
```
# 核心服务类
./services/paths.py - PathsService路径服务类

# API路由
./api/paths.py - 路径管理API接口

# 数据模型  
./models/paths.py - 路径数据模型

# Schema定义
./schemas/paths.py - 路径请求响应模型
```

### 核心服务类 PathsService

PathsService继承自BaseCRUDService，并扩展了路径特有的功能:

```python
class PathsService(BaseCRUDService[Paths, PathsCreate, PathsUpdate]):
```

### 主要功能方法

**路径查询:**
- `get_paths_with_pagination(page_params, conditions)` - 分页查询路径，支持多维度条件过滤
- `get_by_id_with_details(path_id)` - 获取路径详细信息，包含所有关联数据的名称
- `get_options()` - 获取所有下拉选项数据，用于前端级联选择

**Excel数据处理:**
- `export_template()` - 导出Excel模板，包含参考数据和填写说明
- `import_from_excel(file_content, filename)` - 从Excel批量导入路径数据

### 辅助功能

**条件构建器:**
- `_build_path_filter_conditions(conditions)` - 构建复杂的查询条件
- 支持按编码过滤各层级数据（桥梁类别、评定单元、桥梁类型等）

**关联数据处理:**
- `_get_related_data(path)` - 获取路径的所有关联数据名称
- 自动解析外键关系，返回可读性强的数据结构

**Excel处理工具:**
- 集成`utils.excel`模块的辅助函数
- 支持数据验证、模板生成、批量导入等操作

### 业务逻辑场景

**复杂条件查询:**
1. 支持按任意层级编码进行过滤查询
2. 多条件组合查询，如同时按桥梁类型和病害类型过滤
3. 分页展示，提高大数据量下的查询性能

**Excel模板导出:**
1. 动态生成包含所有参考数据的Excel模板
2. 创建多个工作表：主数据表、参考数据表、填写说明
3. 设置表头样式和列宽，提供用户友好的界面

**批量数据导入:**
1. 解析Excel文件，验证数据格式
2. 使用参考数据进行名称到编码的匹配
3. 批量创建路径记录，支持事务回滚
4. 生成详细的导入报告，包含成功、失败和跳过的记录统计

---

## 4.3. 用户路径管理功能模块

这里介绍用户路径管理（User Paths）功能模块。

用户路径管理模块允许用户基于基础路径表创建具体的桥梁实例路径。用户可以创建特定的桥梁实例（如"某某大桥"），并配置其对应的评定单元实例，为后续的检查记录录入和评分计算提供数据基础。

### 核心实现

**主要实现文件:**
```
# 核心服务类
./services/user_paths.py - UserPathsService用户路径服务类

# API路由
./api/user_paths.py - 用户路径管理API接口

# 数据模型
./models/user_paths.py - 用户路径数据模型

# Schema定义  
./schemas/user_paths.py - 用户路径请求响应模型
```

### 核心服务类 UserPathsService

UserPathsService继承自BaseCRUDService，专门处理用户自定义路径:

```python
class UserPathsService(BaseCRUDService[UserPaths, UserPathsCreate, UserPathsUpdate]):
```

### 主要功能方法

**级联选项查询:**
- `get_cascade_options(request)` - 获取级联下拉选项，支持层级联动
- 自动处理空数据层级的递归查询

**嵌套数据结构:**
- `get_nested_user_paths_data(user_id)` - 获取树形结构的用户路径数据
- 构建多层级的嵌套JSON结构，便于前端树形组件展示

**路径验证:**
- 创建前验证路径的完整性和合法性
- 检查用户权限，防止跨用户数据访问

### 辅助功能

**级联选项处理:**
- `_get_bridge_type_options()` - 获取桥梁类型选项
- `_get_part_options(bridge_type_id)` - 获取部位选项  
- `_get_structure_options(bridge_type_id, part_id)` - 获取结构类型选项
- `_get_component_type_options()` - 获取部件类型选项
- `_get_component_form_options()` - 获取构件形式选项

**空数据处理:**
- 智能处理名称为"-"的空数据层级
- 自动跳过空层级，提供更好的用户体验

**嵌套结构构建:**
- 递归构建多层级的树形数据结构
- 保持数据的层次关系和完整性

### 业务逻辑场景

**级联下拉选择:**
1. 用户选择桥梁类型后，动态加载对应的部位选项
2. 逐级联动，直到构件形式层级
3. 自动跳过空数据层级，优化用户体验
4. 支持"-"标识的空数据处理

**用户路径创建:**
1. 验证用户输入的实例名称唯一性
2. 检查基础路径的存在性和合法性
3. 创建用户专属的路径实例
4. 支持管理员创建公共路径（user_id为空）

**树形数据展示:**
1. 按桥梁实例→评定单元→桥梁类型→部位→结构→部件→构件的层级组织数据
2. 构建前端友好的嵌套JSON结构
3. 支持用户筛选，只显示特定用户的路径数据

---

## 4.4. 检查记录管理功能模块

这里介绍检查记录管理（Inspection Records）功能模块。

检查记录管理模块负责处理桥梁检查的具体数据录入，包括病害位置、病害描述、标度选择等。它基于用户路径表的数据结构，记录实际的桥梁检查结果，为评分计算提供基础数据。

### 核心实现

**主要实现文件:**
```
# 核心服务类
./services/inspection_records.py - InspectionRecordsService检查记录服务类

# API路由
./api/inspection_records.py - 检查记录管理API接口

# 数据模型
./models/inspection_records.py - 检查记录数据模型

# Schema定义
./schemas/inspection_records.py - 检查记录请求响应模型
```

### 核心服务类 InspectionRecordsService

InspectionRecordsService继承自BaseCRUDService，专门处理检查记录数据:

```python
class InspectionRecordsService(BaseCRUDService[InspectionRecords, InspectionRecordsCreate, InspectionRecordsUpdate]):
```

### 主要功能方法

**路径验证:**
- `_validate_path_exists(path_request)` - 验证用户路径的存在性
- 确保检查记录基于有效的用户路径创建

**表单选项获取:**
- `get_form_options(path_request)` - 获取表单下拉选项
- 根据构件形式动态加载对应的病害类型和标度选项

**病害参考信息:**
- `get_damage_reference_info(request)` - 获取病害参考信息
- 提供病害类型的详细描述和相关的定性定量信息

**详细信息查询:**
- `get_record_with_details(record_id)` - 获取包含关联数据的详细记录
- 解析所有外键关系，返回可读性强的完整信息

### 辅助功能

**数据匹配工具:**
- 集成`utils.base`模块的辅助函数
- `get_damage_type_id_by_name()` - 根据病害名称获取ID
- `get_scale_id_by_value()` - 根据标度值获取ID

**文件上传处理:**
- 集成文件上传服务，支持检查图片的上传和管理
- 自动处理图片URL的存储和访问

**Excel数据处理:**
- 支持从Excel批量导入检查记录
- 数据验证和格式转换

### 业务逻辑场景

**检查记录创建:**
1. 验证用户路径的存在性和用户权限
2. 根据构件形式加载对应的病害类型选项
3. 验证病害类型和标度的匹配关系
4. 保存检查记录，包括位置描述、图片等信息

**动态表单选项:**
1. 用户选择具体的构件形式
2. 系统根据构件形式查询对应的病害类型
3. 根据病害类型查询对应的标度选项
4. 提供级联的下拉选择体验

**批量数据处理:**
1. 支持按路径条件批量删除检查记录
2. 防止跨用户数据操作，保证数据安全
3. 提供详细的操作结果统计

**病害信息查询:**
1. 根据病害类型提供详细的参考信息
2. 包含定性描述、定量描述等辅助信息
3. 帮助检查人员准确判断和记录病害情况

---

## 4.5. 评分计算功能模块

这里介绍评分计算（Scores）功能模块。

评分计算模块是桥梁评分系统的核心算法模块，实现了复杂的桥梁健康评分算法。它基于检查记录数据，按照构件分→部件分→部位分→总体评分的层级顺序进行计算，并根据特殊规则确定最终的评定等级。

### 核心实现

**主要实现文件:**
```
# 核心服务类
./services/scores.py - ScoresService评分服务类

# API路由
./api/scores.py - 评分管理API接口

# 数据模型
./models/scores.py - 评分数据模型
./models/enums.py - 评分相关枚举（评定等级、计算模式等）

# Schema定义
./schemas/scores.py - 评分请求响应模型
```

### 核心服务类 ScoresService

ScoresService专门处理复杂的评分计算逻辑:

```python
class ScoresService:
```

### 主要功能方法

**评分列表查询:**
- `get_score_list(request)` - 获取评分数据列表，支持权重查询
- `get_cascade_options_for_scores(request)` - 获取评分相关的级联选项

**权重管理:**
- `calculate_weight_allocation(request)` - 计算权重分配
- `save_weight_allocation(request)` - 保存权重分配结果
- 支持默认构件数量和自定义构件数量两种计算模式

**评分计算:**
- `calculate_comprehensive_score(request)` - 计算综合评分
- 实现完整的四级评分算法：构件分→部件分→部位分→总体评分

### 评分算法核心

**构件分计算:**
- 病害数量=0：构件分=100
- 病害数量=1：构件分=100-病害分数
- 病害数量≥2：使用累积扣分公式 `U_i = (score/(100*√i)) * (100-total_u)`
- 病害数量≥100：构件分=0

**部件分计算:**
- 基础公式：平均分 - ((100-最低分)/t值)
- 特殊情况：主要部件且构件分在[0,60)区间时，直接使用构件分

**部位分计算:**
- 部件分与权重的加权平均
- 支持动态权重调整

**总体评分计算:**
- 部位分与部位权重的加权平均
- 应用特殊评定规则

### 辅助功能

**病害分数计算:**
- `_calculate_damage_scores()` - 计算所有病害的具体分数
- 根据标度值和最高标度计算扣分

**权重分配算法:**
- `_prepare_component_counts()` - 准备构件数量数据
- 实现权重重新分配逻辑，处理构件数量为0的情况

**评定等级判断:**
- 实现A、B条件的特殊评定规则
- A条件：上部结构和下部结构为3类、桥面系为4类且总体评分在[40,60)
- B条件：主要部件达到4类或5类时的规则选择

### 业务逻辑场景

**权重动态计算:**
1. 根据桥梁类型获取基础权重配置
2. 统计实际的构件数量或使用自定义数量
3. 对构件数量为0的部件进行权重重新分配
4. 支持用户保存调整后的权重配置

**多级评分计算:**
1. 从检查记录中提取病害数据
2. 按构件分组计算各构件的评分
3. 按部件聚合计算各部件的评分  
4. 按部位加权计算各部位的评分
5. 计算总体评分并确定评定等级

**特殊规则处理:**
1. 判断是否满足特殊评定条件A或B
2. 根据条件优先级确定最终评定等级
3. 支持用户选择是否按规则执行（B条件下）
4. 生成详细的评分报告和等级说明

**级联查询支持:**
1. 提供评分相关的桥梁实例选项
2. 根据选择动态加载评定单元和桥梁类型
3. 支持多维度的评分数据查询和筛选

---

## 工具函数说明

### utils.responses 响应工具

**统一响应格式:**
- `success(data, msg)` - 成功响应，状态码200
- `bad_request(msg)` - 参数错误响应，状态码400  
- `not_found(msg)` - 资源不存在响应，状态码404
- `server_error(msg)` - 服务器错误响应，状态码500

**数据序列化:**
- `_serialize_data(data)` - 自动序列化datetime、BaseModel等复杂数据类型

### utils.base 基础工具

**数据匹配函数:**
- `get_id_by_code(table, code, session)` - 根据编码获取ID
- `match_name_to_code(input_name, ref_key, ref_data, session)` - 名称到编码的智能匹配
- `get_damage_type_id_by_name(name, session)` - 根据病害名称获取ID
- `get_scale_id_by_value(scale_value, session)` - 根据标度值获取ID

**数据处理函数:**
- `parse_range_value(value_str)` - 解析范围值字符串
- `get_assessment_units_by_category(category_id, session)` - 获取分类下的评定单元

### utils.excel Excel处理工具

**模板和验证:**
- `create_reference_data_sheet(worksheet, options)` - 创建参考数据工作表
- `create_help_sheet(worksheet)` - 创建帮助说明工作表
- `validate_excel_data(file_content, filename, reference_data, match_func)` - Excel数据验证
- `validate_row(row_data, reference_data, match_func)` - 单行数据验证

这些工具函数为整个系统提供了统一的数据处理、响应格式化和Excel操作能力，确保了代码的复用性和一致性。